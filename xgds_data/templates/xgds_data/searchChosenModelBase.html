{% extends "base.html" %}
{% load xgds_data_extras %}

{% load url from future %}
{% load nav %}
{% block siteSection %}{{ title }}{% endblock %}

{% block cssExtras %}
{{ block.super }}
<style type="text/css" title="currentStyle">
{% if not standalone %}
	/*
	@import "{{ STATIC_URL }}external/css/jquery/demo_page.css";
	@import "{{ STATIC_URL }}external/css/jquery/demo_table.css";
	*/
{% endif %}
	@import "{{ STATIC_URL }}external/css/jquery/jquery-ui.css";
	@import "{{ STATIC_URL }}xgds_data/css/ResultList.css";
</style>
{% endblock cssExtras %}

{% block scripts %}
  {{ block.super }}
  <script language="javascript" type="text/javascript"
	  src="{{ STATIC_URL }}external/js/jquery/jquery-ui.js"></script>
  <script language="javascript" type="text/javascript"
	  src="{{ STATIC_URL }}external/js/jquery/jquery-ui-timepicker-addon.js"></script>
  <script language="javascript" type="text/javascript"
	  src="{{ STATIC_URL }}external/js/DataTables-1.9.4/jquery.dataTables.min.js"></script>
  <script language="javascript" type="text/javascript"
	  src="{{ STATIC_URL }}external/js/DataTables-1.9.4/FixedColumns.min.js"></script>
  <script type="text/javascript">
  function zeroPad(integer,width) {
	  var string = integer.toString();
	  while (string.length < width) {
		  string = "0"+string;
	  }
	  
	  return string;
  }
  
  function convertToUTC(string) {
	  var months = ['Jan','Feb','Mar','Apr','May','June',
	                'Jul','Aug','Sep','Oct','Nov','Dec'];
	  
	  var d = new Date(string);
	  var mo = zeroPad((1+d.getUTCMonth()),2);
	  var date = zeroPad(d.getUTCDate(),2);
	  var year = d.getUTCFullYear().toString();
	  var hours = zeroPad(d.getUTCHours(),2);
	  var minutes = zeroPad(d.getUTCMinutes(),2);
	  var seconds = zeroPad(d.getUTCSeconds(),2);

	  if (seconds == 0) {
 	     return mo+'/'+date+'/'+year+' '+hours+':'+minutes;
          } else {
 	     return mo+'/'+date+'/'+year+' '+hours+':'+minutes+':'+seconds;
          }
  }
  
{% block submitURL %}
var submitURL="{% url 'xgds_data_searchChosenModel' module model %}"
var submitExpertURL="{% url 'xgds_data_searchChosenModel' module model 'expert' %}"
{% endblock submitURL %}

  function submitform(fnctn)
  {
	if ($('#simple').length == 0) {
		document.QueryForm.action = submitURL;
	} else {
		document.QueryForm.action = submitExpertURL;
	}
	try { 
	{% for f in datetimefields %}
	var timeLo = $('#id_{{f}}_lo').val();
	var timeHi = $('#id_{{f}}_hi').val();
	if (timeLo && timeLo.search(/[\-\+]/) >= 0) {
		var newval = convertToUTC(timeLo);
		$('#id_{{f}}_lo').val(newval);
	}
	if (timeHi && timeHi.search(/[\-\+]/) >= 0) {
		var newval = convertToUTC(timeHi);
		$('#id_{{f}}_hi').val(newval);
	}
	{% endfor %}
	} catch (err) {
		
		alert(err)
	}
	document.QueryForm["fnctn"].value = fnctn;
    document.QueryForm.submit();
    return false;
  }
  
  function changemode(isExpert)
  {
	if (!isExpert) {
		var allOperators = $("[id$=_operator]");
		for (var i=0; i < allOperators.length; i++) {
			allOperators[i].value = allOperators[i].options[0].value;
		}
		document.QueryForm.action = "{% url 'xgds_data_searchChosenModel' module model %}";
	} else {
		document.QueryForm.action = "{% url 'xgds_data_searchChosenModel' module model 'expert' %}";
	}
    document.QueryForm["fnctn"].value = 'change';
	$("#id_pageno").val(1); 
    document.QueryForm.submit();
  }

  function gotoPage(page) {
		$("#id_pageno").val(page);
		document.QueryForm["fnctn"].value = 'query';
		submitform('query');
	}
  
  var oTable;
  
  function syncFramesize() {
		  var nheight = $(window).height(); // New height
		  var nwidth = $(window).width(); // New width

		  //$("#outerresults").height(nheight - 50);
		  $("#outerresults").width(nwidth - 50);
	      //$('div.dataTables_scrollBody').css('height',(nheight - 75)+'px');
	      //$('div.DTFC_LeftBodyWrapper').css('height',(nheight - 75)+'px');
	      //oTable.fnAdjustColumnSizing();
		}
  
  var calcDataTableHeight = function() {
      return '500px';
      //TODO if we know how much room the search takes up we can be smart about how tall to make the results.
/* 	    var h = Math.floor($(window).height()*65/100);
	    return h + 'px';
 */	};

  function initDataFrame() {
      $('#page').height(1200);
      $('#page-content').height(1100);
    var options = {
    	    "sScrollY": calcDataTableHeight(),
    		"sScrollX": "100%",
            "bFilter": false,
            "bInfo": false,
    		"bPaginate": false,
    		"bAutoWidth": true,
    		"bJQueryUI": false,
    		"bSort": false,
    		"aoColumnDefs": [
    			{ "bSortable": false, "bFilter": false, "aTargets": [ 0 ] }
    		]
    	};
	oTable = $('#tableresults').dataTable(options);
	{% if checkable %}
	new FixedColumns( oTable, { "iLeftColumns": 2, "iLeftWidth": 115 } );
	{% else %}
	new FixedColumns( oTable, { "iLeftColumns": 1 } );
	{% endif %}
}

if ($('#tableresults').length) {
	// $(document).ready(initDataFrame);
	$(window).resize(syncFramesize);
}

window.onload = initDataFrame;
  
{% for f in datetimefields %}
var timeFormat = '{{ timeformat }}'
var seconds = false;
if (timeFormat.search("ss") > -1) {
  seconds = true;
}
$('#id_{{f}}_lo').datetimepicker({addSliderAccess: false, showTimezone: true, timezone: '+0000', showSecond: seconds, timeFormat: timeFormat });
$('#id_{{f}}_hi').datetimepicker({addSliderAccess: false, showTimezone: true, timezone: '+0000', showSecond: seconds, timeFormat: timeFormat });
{% endfor %}
$("#addform").click(function() {
	submitform('addform');
});
$("#query").click(function() {
	submitform('query');
});
$("#csv").click(function() {
	submitform('csv');
});
$("#csvhard").click(function() {
	submitform('csvhard');
});
$("#simple").click(function() {
	changemode(false);
});
$("#expert").click(function() {
	changemode(true);
});
$("#plot").click(function() {
	document.QueryForm.action = "{% url 'xgds_data_searchPlotQueryResults' module model 0 10000 %}";
	document.QueryForm.submit();
});
$("#plothard").click(function() {
	document.QueryForm.action = "{% url 'xgds_data_searchPlotQueryResults' module model 'exact' 0 10000 %}";
	document.QueryForm.submit();
});
$("#prevpage").click(function() {
	var page = parseInt($("#id_pageno").val()) - 1;
	gotoPage(page);
});
$("#nextpage").click(function() {
	var page = parseInt($("#id_pageno").val()) + 1;
	gotoPage(page);
});

function resetResults() { 
//	$('#results').html(""); 
	$("#id_pageno").val(1); 
}

$('input[id$="control"]').change(resetResults);
$('input[type=text][id$="_lo"]').change(resetResults);
$('input[type=text][id$="_hi"]').change(resetResults);
$('select').change(resetResults);

$(function () {
    if ({{ autoSubmit }}) {
        $('#query').click();
    }
});
  </script>
  
  <script language="javascript" type="text/javascript"
	  src="{{ STATIC_URL }}external/js/jquery/jquery.flot.min.js"></script>
  <script language="javascript" type="text/javascript"
	  src="{{ STATIC_URL }}external/js/jquery/jquery.flot.threshold.min.js"></script>

{% endblock %}

{% block contents  %}
{% block query %}	
<div style="float:right;text-align:right;">
{% if expert %}
	<A id="simple" class="mybutton">Simple Search</A>
{% else %}
	<A id="expert" class="mybutton">Advanced Search</A>
{% endif %}
</div>
<h2>{{ title }}</h2>  	
{% for d in debug %}
	<span>{{ d }}</span>
{% endfor %}
  <form name="QueryForm" action="" method="post">
  <input type="hidden" name="fnctn" value="query">
  <input type="hidden" name="pageno" id="id_pageno" value={{ page }}>
  
{% if axesform %}
    {% for field in axesform %}
          {{ field.as_hidden }} 
  {% endfor %}
{% endif %}

{{ formset.management_form }}
<table>
    
{% for form in formset %}
    {% if expert %}
		{{ form.as_expert_table }}
	{% else %}
		{{ form.as_table }}
	{% endif %}
    
{% endfor %}

	<tr>
	<td></td>
	<td></td>
	<td><input type="submit" class="mybutton"  value="Search" id="query" /></td>
	</tr>

</table>
 
{% if expert %}
	{% if 'this code' == 'is no longer broken' %}
	<input type="submit" value="Add Disjunction" id="addform" /> 
	{% endif %}
{% endif %}

{% endblock query %}

{% block results  %}

 <div id='results'>    
{% if count %}

	<HR>

{% block count  %}	
	 {% if count != exactCount %}
     <TABLE style="float: right;">
    	{% if standalone %}
     		<TR><TH rowspan=2>Key</TH><TD class="mimicOddResultListExact">Exact</TD><TD class="mimicEvenResultListExact">Match</TD></TR>
     		<TR><TD class="mimicOddResultListInexact">Close</TD><TD class="mimicEvenResultListInexact">Match</TD></TR>    	
    	{% else %}
     		<TR><TH rowspan=2>Key</TH><TD class="mimicOddGradeA">Exact</TD><TD class="mimicEvenGradeA">Match</TD></TR>
     		<TR><TD class="mimicOddGradeX">Close</TD><TD class="mimicEvenGradeX ">Match</TD></TR>
     	{% endif %}
     </TABLE>
     {% endif %}
	
	{% if count == exactCount %}
		{{ count }} matching records
	{% else %}
		About {{ count }} matching records
		{% if exactCount == 0 %}
			(no
		{% else %}
			({{ exactCount }}
		{% endif %}
		exact
		{% if exactCount == 1 %}
			match)
		{% else %}
			matches)
		{% endif %}
	{% endif %}
	in {{ duration }} seconds.
{% endblock %}

<span style="float:right;text-align:right;">
{% block download  %}
	{% if count != exactCount %}
		{% if count > 0 %}
	    	<input type="submit" class="mybutton" value="Download CSV (All)" id="csv" />
	    {% else %}
	    	<input type="submit"  value="Download CSV (All)" id="csv" disabled />
	    {% endif %}
    {% endif %}
    {% if exactCount > 0 %}
    	<input type="submit" class="mybutton"  value="Download CSV (Exact)" id="csvhard" />
    {% else %}
    	<input type="submit" value="Download CSV (Exact)" id="csvhard" disabled />
    {% endif %}
{% endblock %}

{% block plot  %}
    {% if axesform %}
	    {% if count != exactCount %}
		    {% if count > 10000 %}
		    	<input type="submit" class="mybutton" value="Plot (All)" id="plot" title="Plot limited to 10000 records" /> 
		    {% elif count > 0 %}
		    	<input type="submit" class="mybutton" value="Plot (All)" id="plot"/> 
		    {% else %}
		    	<input type="submit" value="Plot (All)" id="plot" disabled /> 
		    {% endif %}
	    {% endif %}
	    {% if exactCount > 10000 %}
	    	<input type="submit" class="mybutton" value="Plot (Exact)" id="plothard" title="Plot limited to 10000 records" /> 
	    {% elif exactCount > 0 %}
	    	<input type="submit" class="mybutton" value="Plot (Exact)" id="plothard"/> 
	    {% else %}
	    	<input type="submit" value="Plot (Exact)" id="plothard" disabled />
	    {% endif %}
    {% endif %}
{% endblock %}
</span>

{% block listing  %}
<div id="outerresults" style="margin-top:15px;">
{% with divpage=1|divide:pageSize %}
	{% with end_index=page|divide:divpage|floatformat:"0"  %}
	{% with start_index=pageSize|divide:-1|add:end_index|add:1  %}
	{% with last_page=count|divide:pageSize|addfloat:0.4999|floatformat:"0"|add:0  %}
	{% with last_page_plus_one=last_page|add:1  %}
	<div id="pager">
	<input type="hidden" name="start" id="id_start">
	<input type="hidden" name="end"  id="id_end">
		<span class="counts">Displaying {{start_index}}-
		{% if end_index|add:"0" < count|add:"0" %}{{end_index}}{% else %}{{count}}{% endif %}
		 out of {{ count }} records</span>
    	{% if standalone %}
			<div class="paginate" style="float:right; margin-bottom:3px;">
    	{% else %}
			<div class="dataTables_paginate" style="float:right; margin-bottom:3px;">
		{% endif %}
		{% if page > 1 %}<a href="javascript:gotoPage({{ page|add:"-1" }});">Previous</a>{% else %}<a class="ui-state-disabled">Previous</a>{%endif%}
		{% for num in 1|range:last_page_plus_one %}  
			{% if num < page|add:"3" and num > page|add:"-3" or num < 3 or num > last_page|add:"-2" %}
			   {% ifequal num page %}
		            <a class="ui-state-disabled">{{num}}</a>
		        {% else %} 
			   		<a href="javascript:gotoPage({{ num }});">{{ num }}</a>
			   	{% endifequal %}
		   {% elif num == page|add:"3" or num == page|add:"-3" %}
		   		...
		   {% endif %}  
		{% endfor %}  
		{% if more %}<a href="javascript:gotoPage({{ page|add:"1" }});">Next</a>{% else %}<a class="ui-state-disabled">Next</a>{%endif%}
	    </div>
	</div>
	{% endwith %}
	{% endwith %}
	{% endwith %}
	{% endwith %}
	{% endwith %}

{% if standalone %}
   <table id="tableresults" class="compact cell-border ResultList">
   <thead>
{% else %}
   <table id="tableresults" class="compact cell-border display">
   <thead class="table_header">
{% endif %}
	<tr>
	{% if checkable %}
	<th><input type="checkbox" id="pick_master" /></th>
	{% endif %}
	<th>Record</th>
	{% for x in displayFields %}
	<th>{{ x|verbose_name }}</th>
	{% endfor %}
   </tr>
   </thead>
	  <tbody>
	{% for result in results %}
		    {% with myscore=result|getattribute:'score' %}
				{% if myscore >= 1 %}
					{% if standalone %}
						<tr class="ResultListExact">
					{% else %}
						<tr class="gradeA">
					{% endif %}
				{% else %}
					{% if standalone %}
						<tr class="ResultListInexact">
					{% else %}
						<tr class="gradeX">
					{% endif %}
				{% endif %}			
		    {% endwith %}

	
		{% if checkable %}
		<td>
			{% with pid=resultfullids|getattribute:result %}
			<input type="checkbox" id="pick_{{pid}}" name="picks" value="{{pid}}" {% if pid in picks %}CHECKED{% endif %} />
			{% endwith %}
		     </td>
	     {% endif %}
	   <td>
             {% if result.get_absolute_url %}
               <a href="{{ result.get_absolute_url }}">{{ result }}</a>
             {% else %}
               <a href="{% url 'xgds_data_displayRecord' result|moduleName result|modelName result|pkValue %}">{{ result }}</a>
             {% endif %}
           </td>
 	 {% for x in displayFields %}
	   <TD >
	  {% with myval=result|getattribute:x %}
	     <SPAN {% if myval|isNumeric %}style="white-space:nowrap;"{% endif %}>
	  	{{ x|display:myval }}
	    </SPAN>
	  {% endwith %}
	  </TD>
	  {% endfor %}
	</tr>

	
	{% endfor %}
		</tbody>
	</table>
</div>

{% endblock listing %}

{% for pid in picks %}
{% if pid not in resultfullids.values %}
<input type="hidden" id="pick_{{pid}}" name="picks" value="{{pid}}" >
{% endif %}
{% endfor %}

	{% with divpage=1|divide:pageSize %}
	{% with end_index=page|divide:divpage|floatformat:"0"  %}
	{% with start_index=pageSize|divide:-1|add:end_index|add:1  %}
	{% with last_page=count|divide:pageSize|addfloat:0.4999|floatformat:"0"|add:0  %}
	{% with last_page_plus_one=last_page|add:1  %}
	<div id="pager">
	<input type="hidden" name="start" id="id_start">
	<input type="hidden" name="end"  id="id_end">
		<span class="counts">Displaying {{start_index}}-
		{% if end_index|add:"0" < count|add:"0" %}{{end_index}}{% else %}{{count}}{% endif %}
		 out of {{ count }} records</span>
    	{% if standalone %}
			<div class="paginate" style="float:right; margin-bottom:3px;">
    	{% else %}
			<div class="dataTables_paginate" style="float:right; margin-bottom:3px;">
		{% endif %}
		{% if page > 1 %}<a href="javascript:gotoPage({{ page|add:"-1" }});">Previous</a>{% else %}<a class="ui-state-disabled">Previous</a>{%endif%}
		{% for num in 1|range:last_page_plus_one %}  
			{% if num < page|add:"3" and num > page|add:"-3" or num < 3 or num > last_page|add:"-2" %}
			   {% ifequal num page %}
		            <a class="ui-state-disabled">{{num}}</a>
		        {% else %} 
			   		<a href="javascript:gotoPage({{ num }});">{{ num }}</a>
			   	{% endifequal %}
		   {% elif num == page|add:"3" or num == page|add:"-3" %}
		   		...
		   {% endif %}  
		{% endfor %}  
		{% if more %}<a href="javascript:gotoPage({{ page|add:"1" }});">Next</a>{% else %}<a class="ui-state-disabled">Next</a>{%endif%}
	    </div>
	</div>
	{% endwith %}
	{% endwith %}
	{% endwith %}
	{% endwith %}
	{% endwith %}


{% elif count == 0 %}
	<HR>
	No records match 
{% endif %}
</div>
</form>

{% endblock %}

{% endblock %}

